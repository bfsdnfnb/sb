<!DOCTYPE html>
<html>
<head>
  <title>Admin Dashboard</title>
  <link rel="stylesheet" href="/style.css">
</head>
<body>
  <header>
    <h1>Welcome, Admin</h1>
    <div id="currentDateTime" style="font-size: 1rem; color: #666; margin-top: 8px;"></div>
  </header>
  <div class="container">
    <% if (success && success.length) { %>
      <div class="message-box" style="background:#d1fae5; border-left:5px solid #10b981; color:#065f46;">
        <%= success[0] %>
      </div> 
    <% } %>
    <% if (error && error.length) { %>
      <div class="message-box" style="background:#fee2e2; border-left:5px solid #ef4444; color:#991b1b;">
        <%= error[0] %>
      </div>
    <% } %>
    <h2>Settings</h2>
    <form method="POST" action="/admin/update-title-prefix">
      <label for="titlePrefix">Starting Number for Auto-Title:</label>
      <input type="number" name="titlePrefix" id="titlePrefix" value="<%= settings.defaultTitlePrefix %>" placeholder="e.g., 3000" required />
      <small style="display: block; color: #666; margin-bottom: 10px;">
        Next video will be titled: "<%= settings.lastVideoNumber + 1 %>"
      </small>
      <input type="submit" value="Update Number">
    </form>

    <hr/>

    <h2>Update Message for Users</h2>
    <form method="POST" action="/admin/update-message">
      <textarea name="content" rows="4" placeholder="Enter message for users"><%= message ? message.content : '' %></textarea>
      <input type="submit" value="Update Message">
    </form>

    <hr/>

    <h2>Add New Video or Playlist</h2>
    <form method="POST" action="/admin/add">
      <input type="text" name="title" placeholder="Title" required />
      <input type="text" name="youtubeUrl" placeholder="Full YouTube video or playlist URL" required />
      <select name="type">
        <option value="video">Video</option>
        <option value="playlist">Playlist</option>
      </select>
      <label for="scheduledStartDate">Scheduled Start Date & Time (IST):</label>
      <input type="datetime-local" id="scheduledStartDate" required />
      <input type="hidden" name="scheduledStartDate" id="scheduledStartDateISO" />
      
      <label for="expiryDate">Expiry Date & Time (IST):</label>
      <input type="datetime-local" id="expiryDate" required />
      <input type="hidden" name="expiryDate" id="expiryDateISO" />
      
      <input type="submit" value="Add">
    </form>

    <hr/>

    <h2>Existing Videos/Playlists</h2>
    <ul>
      <% videos.forEach(v => { %>
        <li>
          <span><strong><%= v.title %></strong> - <%= v.type %></span>
          <% if (v.scheduledStartDate) { %>
            <span style="color: #4f8cff; font-size: 0.9em;">
              | Start: <%= new Date(v.scheduledStartDate).toLocaleString('en-IN', { timeZone: 'Asia/Kolkata' }) %>
            </span>
          <% } %>
          <% if (v.expiryDate) { %>
            <span style="color: #ff6b6b; font-size: 0.9em;">
              | Expires: <%= new Date(v.expiryDate).toLocaleString('en-IN', { timeZone: 'Asia/Kolkata' }) %>
            </span>
          <% } %>
          <form method="POST" action="/admin/delete/<%= v._id %>" style="display:inline;">
            <button type="submit">Delete</button>
          </form>
        </li>
      <% }) %>
    </ul>

    <hr/>

    <h2>User Visit Statistics</h2>
    <div style="overflow-x: auto;">
      <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
        <thead>
          <tr style="background: #f0f0f0;">
            <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">IP Address</th>
            <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Last Visit</th>
            <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Total Time Spent</th>
            <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Visit Count</th>
          </tr>
        </thead>
        <tbody>
          <% if (userVisits && userVisits.length > 0) { %>
            <% userVisits.forEach(visit => { %>
              <tr>
                <td style="border: 1px solid #ddd; padding: 8px;"><%= visit.ipAddress %></td>
                <td style="border: 1px solid #ddd; padding: 8px;">
                  <%= new Date(visit.lastVisit).toLocaleString('en-IN', { timeZone: 'Asia/Kolkata' }) %>
                  <% 
                    const now = new Date();
                    const lastVisit = new Date(visit.lastVisit);
                    const diffMs = now - lastVisit;
                    const diffMins = Math.floor(diffMs / 60000);
                    const diffHours = Math.floor(diffMins / 60);
                    const diffDays = Math.floor(diffHours / 24);
                    let timeAgo = '';
                    if (diffDays > 0) timeAgo = `(${diffDays}d ago)`;
                    else if (diffHours > 0) timeAgo = `(${diffHours}h ago)`;
                    else if (diffMins > 0) timeAgo = `(${diffMins}m ago)`;
                    else timeAgo = '(just now)';
                  %>
                  <span style="color: #666; font-size: 0.85em;"><%= timeAgo %></span>
                </td>
                <td style="border: 1px solid #ddd; padding: 8px;">
                  <% 
                    const totalSeconds = visit.totalTimeSpent || 0;
                    const hours = Math.floor(totalSeconds / 3600);
                    const minutes = Math.floor((totalSeconds % 3600) / 60);
                    const seconds = totalSeconds % 60;
                    let timeStr = '';
                    if (hours > 0) timeStr += `${hours}h `;
                    if (minutes > 0 || hours > 0) timeStr += `${minutes}m `;
                    timeStr += `${seconds}s`;
                  %>
                  <%= timeStr %>
                </td>
                <td style="border: 1px solid #ddd; padding: 8px;"><%= visit.visitCount %></td>
              </tr>
            <% }) %>
          <% } else { %>
            <tr>
              <td colspan="4" style="border: 1px solid #ddd; padding: 8px; text-align: center;">No visits recorded yet</td>
            </tr>
          <% } %>
        </tbody>
      </table>
    </div>
  </div>
  <script>
    // Helpers: treat datetime-local value as IST wall-clock and convert to UTC ISO
    function toISOFromISTLocal(value) {
      if (!value) return null;
      const parts = value.split('T');
      if (parts.length !== 2) return null;
      const [datePart, timePart] = parts;
      const [y, m, d] = datePart.split('-').map(Number);
      const [hh, mm] = timePart.split(':').map(Number);

      // IST offset from UTC is +5.5 hours
      const istOffsetMs = 5.5 * 3600000;

      // Compute UTC ms corresponding to that IST wall-clock
      // Date.UTC treats the components as UTC; subtract IST offset to get true UTC moment
      const utcMs = Date.UTC(y, m - 1, d, hh, mm) - istOffsetMs;
      return new Date(utcMs).toISOString();
    }

    // Get today's date components in IST
    function getTodayISTDateParts() {
      const now = new Date();
      const utcMs = now.getTime() + (now.getTimezoneOffset() * 60000);
      const istMs = utcMs + (5.5 * 3600000);
      const ist = new Date(istMs);
      return {
        year: ist.getUTCFullYear(),
        month: String(ist.getUTCMonth() + 1).padStart(2, '0'),
        day: String(ist.getUTCDate()).padStart(2, '0')
      };
    }

    // Update current IST date/time display
    function updateClock() {
      const now = new Date();
      const istTime = now.toLocaleString('en-IN', { 
        timeZone: 'Asia/Kolkata',
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit',
        hour12: true
      });
      document.getElementById('currentDateTime').textContent = `Current IST: ${istTime}`;
    }

    // Before submit, convert datetime-local values (interpreted as IST) into UTC ISO strings
    document.addEventListener('DOMContentLoaded', function() {
      const addForm = document.querySelector('form[action="/admin/add"]');
      if (addForm) {
        addForm.addEventListener('submit', function(e) {
          try {
            const startInput = document.getElementById('scheduledStartDate');
            const expiryInput = document.getElementById('expiryDate');
            const startISOInput = document.getElementById('scheduledStartDateISO');
            const expiryISOInput = document.getElementById('expiryDateISO');

            console.log('Form submitting...');
            console.log('Start IST value:', startInput ? startInput.value : 'NOT FOUND');
            console.log('Expiry IST value:', expiryInput ? expiryInput.value : 'NOT FOUND');

            if (!startInput || !startInput.value || startInput.value.trim() === '') {
              alert('Scheduled start date is required!');
              e.preventDefault();
              return false;
            }

            if (!expiryInput || !expiryInput.value || expiryInput.value.trim() === '') {
              alert('Expiry date is required!');
              e.preventDefault();
              return false;
            }

            // Convert to ISO and store in hidden fields
            const startISO = toISOFromISTLocal(startInput.value);
            const expiryISO = toISOFromISTLocal(expiryInput.value);

            if (!startISO || !expiryISO) {
              alert('Invalid date format! Please check your dates.');
              console.error('Conversion failed:', { start: startInput.value, expiry: expiryInput.value });
              e.preventDefault();
              return false;
            }

            console.log('Converted start to UTC:', startISO);
            console.log('Converted expiry to UTC:', expiryISO);

            // Validate expiry > start
            const s = new Date(startISO);
            const ex = new Date(expiryISO);
            if (ex <= s) {
              alert('Expiry date must be after the scheduled start date!');
              e.preventDefault();
              return false;
            }

            // Set hidden fields with ISO values
            startISOInput.value = startISO;
            expiryISOInput.value = expiryISO;

            console.log('Form validation passed, submitting with ISO values...');
            return true;
          } catch (error) {
            console.error('Error in form submission:', error);
            alert('Error processing dates: ' + error.message);
            e.preventDefault();
            return false;
          }
        });
      } else {
        console.error('Add form not found!');
      }

      // Set defaults after form listener is attached
      const startInput = document.getElementById('scheduledStartDate');
      const expiryInput = document.getElementById('expiryDate');
      const titleInput = document.querySelector('input[name="title"]');

      const { year, month, day } = getTodayISTDateParts();
      const defaultStartTime = `${year}-${month}-${day}T18:30`;
      const defaultExpiryTime = `${year}-${month}-${day}T20:30`;

      if (startInput && !startInput.value) startInput.value = defaultStartTime;
      if (expiryInput && !expiryInput.value) expiryInput.value = defaultExpiryTime;

      const nextNumber = <%= settings.lastVideoNumber + 1 %>;
      if (titleInput && !titleInput.value) titleInput.value = String(nextNumber);

      // Start clock
      updateClock();
      setInterval(updateClock, 1000); // Update every second
    });
  </script>
</body>
</html>
