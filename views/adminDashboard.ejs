<!DOCTYPE html>
<html>
<head>
  <title>Admin Dashboard</title>
  <link rel="stylesheet" href="/style.css">
</head>
<body>
  <header>
    <h1>Welcome, Admin</h1>
  </header>
  <div class="container">
    <% if (success && success.length) { %>
      <div class="message-box" style="background:#d1fae5; border-left:5px solid #10b981; color:#065f46;">
        <%= success[0] %>
      </div> 
    <% } %>
    <% if (error && error.length) { %>
      <div class="message-box" style="background:#fee2e2; border-left:5px solid #ef4444; color:#991b1b;">
        <%= error[0] %>
      </div>
    <% } %>
    <h2>Settings</h2>
    <form method="POST" action="/admin/update-title-prefix">
      <label for="titlePrefix">Default Title Prefix:</label>
      <input type="text" name="titlePrefix" id="titlePrefix" value="<%= settings.defaultTitlePrefix %>" placeholder="e.g., Video, Lecture, Class" required />
      <small style="display: block; color: #666; margin-bottom: 10px;">
        Next video will be: "<%= settings.defaultTitlePrefix %> <%= settings.lastVideoNumber + 1 %>"
      </small>
      <input type="submit" value="Update Prefix">
    </form>

    <hr/>

    <h2>Update Message for Users</h2>
    <form method="POST" action="/admin/update-message">
      <textarea name="content" rows="4" placeholder="Enter message for users"><%= message ? message.content : '' %></textarea>
      <input type="submit" value="Update Message">
    </form>

    <hr/>

    <h2>Add New Video or Playlist</h2>
    <form method="POST" action="/admin/add">
      <input type="text" name="title" placeholder="Title" required />
      <input type="text" name="youtubeUrl" placeholder="Full YouTube video or playlist URL" required />
      <select name="type">
        <option value="video">Video</option>
        <option value="playlist">Playlist</option>
      </select>
      <label for="scheduledStartDate">Scheduled Start Date & Time (optional):</label>
      <input type="datetime-local" name="scheduledStartDate" id="scheduledStartDate" />
      <label for="expiryDate">Expiry Date & Time (optional):</label>
      <input type="datetime-local" name="expiryDate" id="expiryDate" />
      <input type="submit" value="Add">
    </form>

    <hr/>

    <h2>Existing Videos/Playlists</h2>
    <ul>
      <% videos.forEach(v => { %>
        <li>
          <span><strong><%= v.title %></strong> - <%= v.type %></span>
          <% if (v.scheduledStartDate) { %>
            <span style="color: #4f8cff; font-size: 0.9em;">
              | Start: <%= new Date(v.scheduledStartDate).toLocaleString('en-IN', { timeZone: 'Asia/Kolkata' }) %>
            </span>
          <% } %>
          <% if (v.expiryDate) { %>
            <span style="color: #ff6b6b; font-size: 0.9em;">
              | Expires: <%= new Date(v.expiryDate).toLocaleString('en-IN', { timeZone: 'Asia/Kolkata' }) %>
            </span>
          <% } %>
          <form method="POST" action="/admin/delete/<%= v._id %>" style="display:inline;">
            <button type="submit">Delete</button>
          </form>
        </li>
      <% }) %>
    </ul>

    <hr/>

    <h2>User Visit Statistics</h2>
    <div style="overflow-x: auto;">
      <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
        <thead>
          <tr style="background: #f0f0f0;">
            <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">IP Address</th>
            <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Last Visit</th>
            <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Total Time Spent</th>
            <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Visit Count</th>
          </tr>
        </thead>
        <tbody>
          <% if (userVisits && userVisits.length > 0) { %>
            <% userVisits.forEach(visit => { %>
              <tr>
                <td style="border: 1px solid #ddd; padding: 8px;"><%= visit.ipAddress %></td>
                <td style="border: 1px solid #ddd; padding: 8px;">
                  <%= new Date(visit.lastVisit).toLocaleString('en-IN', { timeZone: 'Asia/Kolkata' }) %>
                  <% 
                    const now = new Date();
                    const lastVisit = new Date(visit.lastVisit);
                    const diffMs = now - lastVisit;
                    const diffMins = Math.floor(diffMs / 60000);
                    const diffHours = Math.floor(diffMins / 60);
                    const diffDays = Math.floor(diffHours / 24);
                    let timeAgo = '';
                    if (diffDays > 0) timeAgo = `(${diffDays}d ago)`;
                    else if (diffHours > 0) timeAgo = `(${diffHours}h ago)`;
                    else if (diffMins > 0) timeAgo = `(${diffMins}m ago)`;
                    else timeAgo = '(just now)';
                  %>
                  <span style="color: #666; font-size: 0.85em;"><%= timeAgo %></span>
                </td>
                <td style="border: 1px solid #ddd; padding: 8px;">
                  <% 
                    const totalSeconds = visit.totalTimeSpent || 0;
                    const hours = Math.floor(totalSeconds / 3600);
                    const minutes = Math.floor((totalSeconds % 3600) / 60);
                    const seconds = totalSeconds % 60;
                    let timeStr = '';
                    if (hours > 0) timeStr += `${hours}h `;
                    if (minutes > 0 || hours > 0) timeStr += `${minutes}m `;
                    timeStr += `${seconds}s`;
                  %>
                  <%= timeStr %>
                </td>
                <td style="border: 1px solid #ddd; padding: 8px;"><%= visit.visitCount %></td>
              </tr>
            <% }) %>
          <% } else { %>
            <tr>
              <td colspan="4" style="border: 1px solid #ddd; padding: 8px; text-align: center;">No visits recorded yet</td>
            </tr>
          <% } %>
        </tbody>
      </table>
    </div>
  </div>
  <script>
    // Set default dates and times
    window.addEventListener('DOMContentLoaded', function() {
      const startInput = document.getElementById('scheduledStartDate');
      const expiryInput = document.getElementById('expiryDate');
      const titleInput = document.querySelector('input[name="title"]');
      
      // Get today's date
      const today = new Date();
      const year = today.getFullYear();
      const month = String(today.getMonth() + 1).padStart(2, '0');
      const day = String(today.getDate()).padStart(2, '0');
      
      // Set default times: 18:30 for start, 20:30 for expiry
      const defaultStartTime = `${year}-${month}-${day}T18:30`;
      const defaultExpiryTime = `${year}-${month}-${day}T20:30`;
      
      startInput.value = defaultStartTime;
      expiryInput.value = defaultExpiryTime;
      
      // Set default title
      const titlePrefix = '<%= settings.defaultTitlePrefix %>';
      const nextNumber = <%= settings.lastVideoNumber + 1 %>;
      titleInput.value = `${titlePrefix} ${nextNumber}`;
    });
    
    // When form is submitted, ensure datetime-local values are correctly interpreted
    document.querySelector('form[action="/admin/add"]').addEventListener('submit', function(e) {
      const startInput = document.getElementById('scheduledStartDate');
      const expiryInput = document.getElementById('expiryDate');
      
      // datetime-local gives us local time, but we need to store it as UTC in the database
      // The browser automatically handles this when we send the ISO string to the server
      
      // Optional: Add validation
      if (startInput.value && expiryInput.value) {
        const startDate = new Date(startInput.value);
        const expiryDate = new Date(expiryInput.value);
        
        if (expiryDate <= startDate) {
          alert('Expiry date must be after the scheduled start date!');
          e.preventDefault();
          return false;
        }
      }
    });
  </script>
</body>
</html>
