<!DOCTYPE html>
<html>
  <head>
    <title>YouTube Meown !</title>
    <link rel="stylesheet" href="/style.css">
  </head>
  <body>
    <header>
      <h1>YouTube Meown!</h1>
    </header>
    <div class="container">
      <% if (message) { %>
        <div class="message-box">
          <strong>Vikas Message:</strong>
          <p><%= message.content %></p>
        </div>
      <% } %>

      <% if (success && success.length) { %>
        <div class="message-box" style="background:#d1fae5; border-left:5px solid #10b981; color:#065f46;">
          <%= success[0] %>
        </div>
      <% } %>
      <% if (error && error.length) { %>
        <div class="message-box" style="background:#fee2e2; border-left:5px solid #ef4444; color:#991b1b;">
          <%= error[0] %>
        </div>
      <% } %>

      <% videos.forEach((v, idx) => { %>
        <div style="margin-bottom: 30px;">
          <div style="position:relative;">
            <% if (v.type === 'video') { %>
              <iframe
                id="iframe-<%= idx %>"
                width="560"
                height="315"
                src="https://www.youtube-nocookie.com/embed/<%= v.youtubeId %>?rel=0"
                allow="fullscreen"
                allowfullscreen
              ></iframe>
            <% } else { %>
              <iframe
                id="iframe-<%= idx %>"
                width="560"
                height="315"
                src="https://www.youtube-nocookie.com/embed/videoseries?list=<%= v.youtubeId %>&rel=0"
                allow="fullscreen"
                allowfullscreen
              ></iframe>
            <% } %>
            <button onclick="makeFullScreen('iframe-<%= idx %>')" style="position:absolute;top:10px;right:10px;z-index:2;">Fullscreen</button>
          </div>
          <p style="font-weight: bold; margin-top: 8px;"><%= v.title %></p>
          <% if (v.scheduledStartDate) { %>
            <div style="color:#4f8cff; font-size:0.9em; margin-top:4px;">
              Start: <%= new Date(v.scheduledStartDate).toLocaleString('en-IN', { timeZone: 'Asia/Kolkata' }) %>
            </div>
          <% } %>
          <% if (v.expiryDate) { %>
            <div style="color:#ff6b6b; font-size:0.9em; margin-top:2px;">
              Expires: <%= new Date(v.expiryDate).toLocaleString('en-IN', { timeZone: 'Asia/Kolkata' }) %>
            </div>
          <% } %>
        </div>
      <% }) %>

      <div style="text-align:center; margin-top:20px;">
        <% if (totalPages > 1) { %>
          <% for (let i = 1; i <= totalPages; i++) { %>
            <% if (i === page) { %>
              <span style="font-weight:bold; color:#4f8cff; margin:0 5px;"><%= i %></span>
            <% } else { %>
              <a href="/?page=<%= i %>" style="margin:0 5px; color:#22223b;"><%= i %></a>
            <% } %>
          <% } %>
        <% } %>
      </div>
    </div>

    <script>
      function makeFullScreen(id) {
        const iframe = document.getElementById(id);
        const requestFullScreen =
          iframe.requestFullscreen ||
          iframe.mozRequestFullScreen ||
          iframe.webkitRequestFullscreen ||
          iframe.msRequestFullscreen;
        if (requestFullScreen) {
          requestFullScreen.call(iframe);
        } else {
          alert('Fullscreen not supported in this browser.');
        }
      }

      // Track time spent on website
      let startTime = Date.now();
      let lastUpdate = startTime;

      // Send time update every 30 seconds
      setInterval(() => {
        const now = Date.now();
        const elapsed = Math.floor((now - lastUpdate) / 1000); // seconds since last update
        lastUpdate = now;

        if (elapsed > 0) {
          fetch('/track-time', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ timeSpent: elapsed })
          }).catch(err => console.error('Error tracking time:', err));
        }
      }, 30000); // Every 30 seconds

      // Send final update when user leaves
      window.addEventListener('beforeunload', () => {
        const now = Date.now();
        const elapsed = Math.floor((now - lastUpdate) / 1000);
        if (elapsed > 0) {
          navigator.sendBeacon('/track-time', JSON.stringify({ timeSpent: elapsed }));
        }
      });

      // Track when user returns after being away (e.g., switched tabs)
      document.addEventListener('visibilitychange', () => {
        const now = Date.now();
        if (document.hidden) {
          // User left - update time
          const elapsed = Math.floor((now - lastUpdate) / 1000);
          if (elapsed > 0) {
            fetch('/track-time', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({ timeSpent: elapsed })
            }).catch(err => console.error('Error tracking time:', err));
          }
        } else {
          // User returned - reset timer
          lastUpdate = Date.now();
        }
      });
    </script>
  </body>
</html>
 